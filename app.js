import fs from"fs/promises";import express from"express";import cookieSession from"cookie-session";import path from"path";import url from"url";import http from"http";import os from"os";let dev="--dev"===process.argv[2],dir=path.dirname(url.fileURLToPath(import.meta.url)),app=express(),server=http.createServer(app),vite;if(dev){let e=(await import("vite")).createServer;vite=await e({server:{middlewareMode:!0},appType:"custom",base:"/"}),app.use(vite.middlewares)}else{let e=(await import("compression")).default,a=(await import("sirv")).default;app.use(e()),app.use("/",a("./client",{extensions:[],maxAge:2592e3,immutable:!0}))}let g=dev?await(await vite.ssrLoadModule(path.resolve(dir,"./entryServer.js"))).gGet():await(await import("./server/index.js")).gGet(),dirEnv=path.resolve(dir,dev?`../${g.g.a.config.dir}/config/.env`:"./.env"),localUrl=(g.g.f.config.env=await g.gfToolBack.env.init(dirEnv),null);g.g.f.config.local.status="SAMI"===process.env.COMPUTERNAME,g.g.f.config.local.api=g.g.f.config.local.status&&!!g.g.a.config.local.api,g.g.f.config.local.dev=dev;try{let o=null,e=(os.networkInterfaces()["Wi-Fi"].forEach((e,a)=>{"IPv4"===e.family&&(o=e.address)}),"http://"+o+":");g.g.a.config.local.api=e+g.g.a.config.local.api,localUrl=e+g.g.f.config.env.port}catch(e){g.g.f.config.local.api=!1,g.g.a.config.local.api=null,localUrl=null}async function sitemap(e,i){try{let a="",o=[],t=[],s=g.g.a.config.domaiH.main;"/sitemap.xml"===e.baseUrl?g.g.a.config.sitemap&&g.g.a.config.sitemap.forEach(e=>{o.push({loc:s+"/"+e+".xml"})}):"/sitemap-main.xml"===e.baseUrl&&g.g.a.route.routes.forEach(e=>{e.path.includes(":")||"/"===e.path||t.push({loc:s+e.path})}),o.length&&(a+='<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" xmlns:news="http://www.google.com/schemas/sitemap-news/0.9" xmlns:xhtml="http://www.w3.org/1999/xhtml" xmlns:image="http://www.google.com/schemas/sitemap-image/1.1" xmlns:video="http://www.google.com/schemas/sitemap-video/1.1">',o.forEach(e=>{a+="<sitemap>",e.loc&&(a+="<loc>"+e.loc+"</loc>"),e.lastmod&&(a+="<lastmod>"+e.lastmod+"</lastmod>"),a+="</sitemap>"}),a+="</sitemapindex>"),t.length&&(a+='<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" xmlns:news="http://www.google.com/schemas/sitemap-news/0.9" xmlns:xhtml="http://www.w3.org/1999/xhtml" xmlns:image="http://www.google.com/schemas/sitemap-image/1.1" xmlns:video="http://www.google.com/schemas/sitemap-video/1.1">',t.forEach(e=>{a+="<url>",e.loc&&(a+="<loc>"+e.loc+"</loc>"),e.lastmod&&(a+="<lastmod>"+e.lastmod+"</lastmod>"),e.image&&(a+="<image:image><image:loc>"+e.image+"</image:loc></image:image>"),a+="</url>"}),a+="</urlset>"),""!==a?i.status(200).set({"Content-Type":"application/xml"}).send(a):i.redirect("/")}catch(e){i.redirect("/")}}async function backend(e,a){let o;try{var t=await g.g.f.help.crypto.deJson(e.query.data);o=await g.g.f.help.api.req({t:t.target,p:t.prop,d:t.data},!0),"user.login"===t.target&&o.ok&&o.rt&&(e.session.user=o.rt),"user.logout"===t.target&&o.ok&&o.rt&&(e.session.user=o.rt),o=await g.g.f.help.crypto.enJson(o)}catch(e){o=null}a.status(200).set({"Content-Type":"application/json"}).send(o)}async function frontend(a,o){let t;try{let e;e=dev?(t=await vite.transformIndexHtml(a.originalUrl,await fs.readFile(path.resolve(dir,"../a_Fork/public/index.html"),"utf-8")),await(await vite.ssrLoadModule(path.resolve(dir,"./entryServer.js"))).create(a)):(t=await fs.readFile("./client/index.html","utf-8"),await(await import("./server/index.js")).create(a)),t=t.replace("\x3c!--app-head--\x3e",e.head).replace("\x3c!--app-body--\x3e",e.body),o.status(200).set({"Content-Type":"text/html","Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate",Pragma:"no-cache",Expires:"0","Surrogate-Control":"no-store"}).send(t)}catch(e){console.log(e.stack),o.status(500).set().send("Internal Server Error")}}g.g.a.store.user&&(app.set("trust proxy",1),app.use(cookieSession({name:"session",keys:[g.g.f.config.env.token],maxAge:36e5*g.g.f.config.session.age}))),app.use("*all",async(e,a)=>{try{"/sitemap"===e.baseUrl.slice(0,8)?await sitemap(e,a):"/backend"===e.baseUrl?await backend(e,a):await frontend(e,a)}catch(e){vite?.ssrFixStacktrace(e),console.log(e.stack),a.status(500).end(e.stack)}}),server.listen(g.g.f.config.env.port,()=>{console.log("=================================================="),console.log("SERVER , RUN "),console.log("=================================================="),console.log("= app  : "+g.g.a.config.domain.main),console.log("= ver  : "+g.g.a.config.ver),console.log("= port : "+g.g.f.config.env.port),dev?(console.log("= url  : "+localUrl),console.log("= api  : "+(g.g.f.config.local.api?g.g.a.config.local:g.g.a.config.domaiH).api)):(console.log("= url  : "+g.g.a.config.domaiH.main),console.log("= api  : "+g.g.a.config.domaiH.api)),console.log("==================================================")});